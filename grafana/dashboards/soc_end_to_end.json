{
  "uid": "soc-end-to-end",
  "title": "SOC End-to-End",
  "timezone": "utc",
  "schemaVersion": 39,
  "version": 1,
  "refresh": "30s",
  "tags": ["soc-lab", "e2e"],
  "templating": {
    "list": [
      {
        "name": "DS_CLICKHOUSE",
        "type": "datasource",
        "label": "ClickHouse",
        "query": "grafana-clickhouse-datasource",
        "current": { "text": "ClickHouse", "value": "ClickHouse" }
      },
      {
        "name": "project",
        "type": "query",
        "label": "Project",
        "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
        "query": "SELECT distinct project FROM soc.raw_logs ORDER BY project",
        "refresh": 1,
        "multi": false,
        "includeAll": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      },
      {
        "name": "cluster",
        "type": "query",
        "label": "Cluster",
        "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
        "query": "SELECT distinct cluster FROM soc.raw_logs WHERE match(project, '$project') ORDER BY cluster",
        "refresh": 1,
        "multi": false,
        "includeAll": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      },
      {
        "name": "namespace",
        "type": "query",
        "label": "Namespace",
        "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
        "query": "SELECT distinct namespace FROM soc.raw_logs WHERE match(project, '$project') AND match(cluster, '$cluster') ORDER BY namespace",
        "refresh": 1,
        "multi": false,
        "includeAll": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      },
      {
        "name": "service",
        "type": "query",
        "label": "Service",
        "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
        "query": "SELECT distinct service FROM soc.raw_logs WHERE match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') ORDER BY service",
        "refresh": 1,
        "multi": false,
        "includeAll": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      }
    ]
  },
  "panels": [
    {
      "type": "stat",
      "title": "Raw Logs (last 1h)",
      "gridPos": { "h": 4, "w": 6, "x": 0, "y": 0 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT count() AS value\nFROM soc.raw_logs\nWHERE timestamp >= now() - INTERVAL 1 HOUR\n  AND match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') AND match(service, '$service')"
        }
      ]
    },
    {
      "type": "stat",
      "title": "Anomalies (last 24h)",
      "gridPos": { "h": 4, "w": 6, "x": 6, "y": 0 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT count() AS value\nFROM soc.anomalies\nWHERE window >= now() - INTERVAL 24 HOUR\n  AND match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') AND match(service, '$service')"
        }
      ],
      "fieldConfig": { "defaults": { "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "orange", "value": 10 }, { "color": "red", "value": 50 }] } } }
    },
    {
      "type": "stat",
      "title": "Rule Matches (last 24h)",
      "gridPos": { "h": 4, "w": 6, "x": 12, "y": 0 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT count() AS value\nFROM soc.rule_matches\nWHERE window >= now() - INTERVAL 24 HOUR\n  AND match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') AND match(service, '$service')"
        }
      ],
      "fieldConfig": { "defaults": { "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "orange", "value": 10 }, { "color": "red", "value": 50 }] } } }
    },
    {
      "type": "stat",
      "title": "Alerts Sent (last 24h)",
      "gridPos": { "h": 4, "w": 6, "x": 18, "y": 0 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT countIf(sent = 1) AS value\nFROM soc.alerts\nWHERE created_at >= now() - INTERVAL 24 HOUR"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Ingest Rate (raw_logs)",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 4 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT toStartOfMinute(timestamp) AS time, count() AS value\nFROM soc.raw_logs\nWHERE $__timeFilter(timestamp)\n  AND match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') AND match(service, '$service')\nGROUP BY time\nORDER BY time"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Anomaly Score (avg)",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 4 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT window AS time, avg(score) AS value\nFROM soc.anomalies\nWHERE $__timeFilter(window)\n  AND match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') AND match(service, '$service')\nGROUP BY time\nORDER BY time"
        }
      ],
      "fieldConfig": { "defaults": { "min": 0, "max": 1 } }
    },
    {
      "type": "table",
      "title": "Latest Incidents (LLM summaries)",
      "gridPos": { "h": 12, "w": 24, "x": 0, "y": 12 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT *\nFROM (\n  SELECT created_at, window, project, cluster, namespace, service, risk_level, score, confidence,\n         (llm_summary != '') AS llm_present,\n         substring(if(llm_summary != '', llm_summary, reason), 1, 1200) AS llm_summary\n  FROM soc.anomalies\n  WHERE window >= now() - INTERVAL 7 DAY\n    AND match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') AND match(service, '$service')\n  ORDER BY created_at DESC\n  LIMIT 50\n)\nORDER BY created_at ASC"
        }
      ]
    },
    {
      "type": "table",
      "title": "Latest Rule Matches",
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 24 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT *\nFROM (\n  SELECT created_at, window, severity, rule_id, project, cluster, namespace, service, identity, description\n  FROM soc.rule_matches\n  WHERE window >= now() - INTERVAL 7 DAY\n    AND match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') AND match(service, '$service')\n  ORDER BY created_at DESC\n  LIMIT 100\n)\nORDER BY created_at ASC"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Failed Logins (5m)",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 34 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT window_start AS time,\n       sum(failed_logins) AS value\nFROM soc.features\nWHERE $__timeFilter(window_start)\n  AND match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') AND match(service, '$service')\nGROUP BY time\nORDER BY time"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "IAM Changes (5m)",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 34 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT window_start AS time,\n       sum(iam_change_count) AS value\nFROM soc.features\nWHERE $__timeFilter(window_start)\n  AND match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') AND match(service, '$service')\nGROUP BY time\nORDER BY time"
        }
      ]
    },
    {
      "type": "piechart",
      "title": "Threat Distribution (anomalies by risk_level, 24h)",
      "gridPos": { "h": 10, "w": 8, "x": 0, "y": 42 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT risk_level AS name, count() AS value\nFROM soc.anomalies\nWHERE window >= now() - INTERVAL 24 HOUR\n  AND match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') AND match(service, '$service')\nGROUP BY risk_level\nORDER BY value DESC"
        }
      ]
    },
    {
      "type": "bargauge",
      "title": "Top Attack Sources (failed logins, 24h)",
      "gridPos": { "h": 10, "w": 8, "x": 8, "y": 42 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT ip AS name, count() AS value\nFROM soc.enriched_logs\nWHERE timestamp >= now() - INTERVAL 24 HOUR\n  AND (method = 'app/login' OR positionCaseInsensitive(method, 'login') > 0)\n  AND (severity_num >= 40 OR status_code >= 400)\n  AND ip != ''\n  AND match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') AND match(service, '$service')\nGROUP BY ip\nORDER BY value DESC\nLIMIT 10"
        }
      ]
    },
    {
      "type": "bargauge",
      "title": "Top Risk Services (anomalies, 24h)",
      "gridPos": { "h": 10, "w": 8, "x": 16, "y": 42 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT service AS name, count() AS value\nFROM soc.anomalies\nWHERE window >= now() - INTERVAL 24 HOUR\n  AND match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') AND match(service, '$service')\nGROUP BY service\nORDER BY value DESC\nLIMIT 10"
        }
      ]
    },
    {
      "type": "table",
      "title": "Live Event Stream (signals + rules + anomalies)",
      "gridPos": { "h": 14, "w": 24, "x": 0, "y": 52 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT *\nFROM (\n  SELECT ts, kind, project, cluster, namespace, service, severity, user, sourceIp, details\n  FROM (\n    SELECT created_at AS ts,\n           'anomaly' AS kind,\n           project, cluster, namespace, service,\n           risk_level AS severity,\n           '' AS user,\n           '' AS sourceIp,\n           concat(model, ' score=', toString(round(score, 3)), ' ', substring(reason, 1, 220)) AS details\n    FROM soc.anomalies\n    WHERE created_at >= now() - INTERVAL 24 HOUR\n      AND match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') AND match(service, '$service')\n\n    UNION ALL\n\n    SELECT created_at AS ts,\n           'signal' AS kind,\n           project, cluster, namespace, service,\n           severity,\n           '' AS user,\n           '' AS sourceIp,\n           concat(signal_type, ' ', substring(toJSONString(data), 1, 220)) AS details\n    FROM soc.anomaly_signals\n    WHERE created_at >= now() - INTERVAL 24 HOUR\n      AND match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') AND match(service, '$service')\n\n    UNION ALL\n\n    SELECT created_at AS ts,\n           'rule' AS kind,\n           project, cluster, namespace, service,\n           severity,\n           identity AS user,\n           JSONExtractString(toJSONString(evidence), 'ip') AS sourceIp,\n           concat(rule_id, ' ', description) AS details\n    FROM soc.rule_matches\n    WHERE created_at >= now() - INTERVAL 24 HOUR\n      AND match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') AND match(service, '$service')\n  )\n  ORDER BY ts DESC\n  LIMIT 200\n)\nORDER BY ts ASC"
        }
      ]
    }
  ]
}

