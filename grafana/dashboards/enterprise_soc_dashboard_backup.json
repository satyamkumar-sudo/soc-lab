{
  "uid": "enterprise-soc",
  "title": "SOC Ops (Production)",
  "timezone": "utc",
  "schemaVersion": 39,
  "version": 3,
  "refresh": "30s",
  "tags": ["soc-lab", "production"],
  "time": { "from": "now-6h", "to": "now" },
  "templating": {
    "list": [
      {
        "name": "DS_CLICKHOUSE",
        "type": "datasource",
        "label": "ClickHouse",
        "query": "grafana-clickhouse-datasource",
        "current": { "text": "ClickHouse", "value": "ClickHouse" }
      },
      {
        "name": "project",
        "type": "query",
        "label": "Project",
        "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
        "query": "SELECT distinct project FROM soc.raw_logs ORDER BY project",
        "refresh": 1,
        "multi": false,
        "includeAll": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      },
      {
        "name": "cluster",
        "type": "query",
        "label": "Cluster",
        "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
        "query": "SELECT distinct cluster FROM soc.raw_logs WHERE match(project, '$project') ORDER BY cluster",
        "refresh": 1,
        "multi": false,
        "includeAll": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      },
      {
        "name": "namespace",
        "type": "query",
        "label": "Namespace",
        "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
        "query": "SELECT distinct namespace FROM soc.raw_logs WHERE match(project, '$project') AND match(cluster, '$cluster') ORDER BY namespace",
        "refresh": 1,
        "multi": false,
        "includeAll": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      },
      {
        "name": "service",
        "type": "query",
        "label": "Service",
        "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
        "query": "SELECT distinct service FROM soc.raw_logs WHERE match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') ORDER BY service",
        "refresh": 1,
        "multi": false,
        "includeAll": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      }
    ]
  },
  "panels": [
    {
      "type": "table",
      "title": "ðŸš¨ TOP 10 SECURITY THREATS (Last 24h)",
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 0 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "WITH threat_data AS (\n  SELECT\n    rule_id,\n    rule_name,\n    severity,\n    description,\n    count() AS occurrences,\n    uniq(service) AS affected_services,\n    uniq(identity) AS unique_identities,\n    uniq(namespace) AS affected_namespaces,\n    max(created_at) AS last_seen,\n    multiIf(\n      severity='critical', 1,\n      severity='high', 2,\n      severity='medium', 3,\n      severity='low', 4,\n      5\n    ) AS severity_order\n  FROM soc.rule_matches\n  WHERE created_at >= now() - INTERVAL 24 HOUR\n    AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\n  GROUP BY rule_id, rule_name, severity, description\n)\nSELECT\n  rule_name AS \"Threat Name\",\n  severity AS \"Severity\",\n  occurrences AS \"Count (24h)\",\n  affected_services AS \"Services\",\n  affected_namespaces AS \"Namespaces\",\n  unique_identities AS \"Users/IDs\",\n  formatDateTime(last_seen, '%Y-%m-%d %H:%M') AS \"Last Seen\",\n  substring(description, 1, 80) AS \"Description\"\nFROM threat_data\nORDER BY severity_order ASC, occurrences DESC\nLIMIT 10"
        }
      ],
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          { "matcher": { "id": "byName", "options": "Severity" }, "properties": [
            { "id": "custom.cellOptions", "value": { "type": "color-background" } },
            { "id": "mappings", "value": [
              { "type": "value", "options": { "critical": { "color": "dark-red", "text": "CRITICAL" } } },
              { "type": "value", "options": { "high": { "color": "dark-orange", "text": "HIGH" } } },
              { "type": "value", "options": { "medium": { "color": "dark-yellow", "text": "MEDIUM" } } },
              { "type": "value", "options": { "low": { "color": "dark-blue", "text": "LOW" } } }
            ]}
          ]},
          { "matcher": { "id": "byName", "options": "Count (24h)" }, "properties": [
            { "id": "custom.cellOptions", "value": { "type": "color-background" } },
            { "id": "thresholds", "value": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 10 },
                { "color": "orange", "value": 50 },
                { "color": "red", "value": 100 }
              ]
            }}
          ]}
        ]
      },
      "options": { "showHeader": true, "sortBy": [] }
    },

    {
      "type": "table",
      "title": "ðŸ” LOGIN ATTEMPTS ANALYSIS (Last 24h)",
      "gridPos": { "h": 9, "w": 24, "x": 0, "y": 10 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT\n  ip AS \"Source IP\",\n  identity AS \"User/Identity\",\n  geo_country AS \"Country\",\n  service AS \"Service\",\n  namespace AS \"Namespace\",\n  countIf(severity_num >= 40 OR status_code >= 400) AS \"Failed Attempts\",\n  countIf(severity_num < 40 AND status_code < 400) AS \"Successful Logins\",\n  count() AS \"Total Attempts\",\n  round(countIf(severity_num >= 40) * 100.0 / count(), 1) AS \"Failure Rate %\",\n  max(timestamp) AS \"Last Attempt\"\nFROM soc.enriched_logs\nWHERE timestamp >= now() - INTERVAL 24 HOUR\n  AND (\n    positionCaseInsensitive(method, 'login') > 0 OR\n    positionCaseInsensitive(method, 'auth') > 0 OR\n    positionCaseInsensitive(message, 'login') > 0 OR\n    positionCaseInsensitive(message, 'authentication') > 0 OR\n    positionCaseInsensitive(message, 'Wrong pin') > 0 OR\n    positionCaseInsensitive(message, 'Failed password') > 0\n  )\n  AND ip != ''\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY ip, identity, geo_country, service, namespace\nORDER BY \"Failed Attempts\" DESC, \"Total Attempts\" DESC\nLIMIT 50"
        }
      ],
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          { "matcher": { "id": "byName", "options": "Failed Attempts" }, "properties": [
            { "id": "custom.cellOptions", "value": { "type": "color-background" } },
            { "id": "thresholds", "value": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 3 },
                { "color": "orange", "value": 10 },
                { "color": "red", "value": 50 }
              ]
            }}
          ]},
          { "matcher": { "id": "byName", "options": "Failure Rate %" }, "properties": [
            { "id": "custom.cellOptions", "value": { "type": "color-background" } },
            { "id": "thresholds", "value": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 30 },
                { "color": "orange", "value": 60 },
                { "color": "red", "value": 80 }
              ]
            }}
          ]}
        ]
      }
    },

    {
      "type": "stat",
      "title": "Total Logs (24h)",
      "gridPos": { "h": 4, "w": 4, "x": 0, "y": 19 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT count() AS value\nFROM soc.raw_logs\nWHERE timestamp >= now() - INTERVAL 24 HOUR\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": { "defaults": { "color": { "mode": "fixed", "fixedColor": "blue" }, "unit": "short" } }
    },
    {
      "type": "stat",
      "title": "Total Anomalies (24h)",
      "gridPos": { "h": 4, "w": 4, "x": 4, "y": 19 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT count() AS value\nFROM soc.anomalies\nWHERE created_at >= now() - INTERVAL 24 HOUR\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": { "defaults": { "color": { "mode": "fixed", "fixedColor": "purple" }, "unit": "short" } }
    },
    {
      "type": "stat",
      "title": "Total Signals (24h)",
      "gridPos": { "h": 4, "w": 4, "x": 8, "y": 19 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT count() AS value\nFROM soc.anomaly_signals\nWHERE created_at >= now() - INTERVAL 24 HOUR\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": { "defaults": { "color": { "mode": "fixed", "fixedColor": "yellow" }, "unit": "short" } }
    },
    {
      "type": "stat",
      "title": "Rule Matches (24h)",
      "gridPos": { "h": 4, "w": 4, "x": 12, "y": 19 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT count() AS value\nFROM soc.rule_matches\nWHERE created_at >= now() - INTERVAL 24 HOUR\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": { "defaults": { "color": { "mode": "fixed", "fixedColor": "orange" }, "unit": "short" } }
    },
    {
      "type": "stat",
      "title": "Critical Incidents (24h)",
      "gridPos": { "h": 4, "w": 4, "x": 16, "y": 19 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT countIf(risk_level='critical') + countIf(risk_level='high') AS value\nFROM soc.anomalies\nWHERE created_at >= now() - INTERVAL 24 HOUR\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 5 },
              { "color": "red", "value": 20 }
            ]
          }
        }
      }
    },
    {
      "type": "stat",
      "title": "Ingest Lag (min)",
      "gridPos": { "h": 4, "w": 4, "x": 20, "y": 19 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT dateDiff('minute', max(timestamp), now()) AS value\nFROM soc.raw_logs\nWHERE match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "m",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 5 },
              { "color": "red", "value": 15 }
            ]
          }
        }
      }
    },

    {
      "type": "timeseries",
      "title": "Detections Timeline (5m)",
      "gridPos": { "h": 9, "w": 16, "x": 0, "y": 23 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT toStartOfFiveMinute(created_at) AS time,\n       countIf(risk_level='critical') AS \"Critical\",\n       countIf(risk_level='high') AS \"High\",\n       countIf(risk_level='medium') AS \"Medium\",\n       countIf(risk_level='low') AS \"Low\"\nFROM soc.anomalies\nWHERE $__timeFilter(created_at)\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY time\nORDER BY time"
        },
        {
          "refId": "B",
          "queryType": "sql",
          "rawSql": "SELECT toStartOfFiveMinute(created_at) AS time,\n       count() AS \"Anomaly Signals\"\nFROM soc.anomaly_signals\nWHERE $__timeFilter(created_at)\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY time\nORDER BY time"
        },
        {
          "refId": "C",
          "queryType": "sql",
          "rawSql": "SELECT toStartOfFiveMinute(created_at) AS time,\n       count() AS \"Rule Matches\"\nFROM soc.rule_matches\nWHERE $__timeFilter(created_at)\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY time\nORDER BY time"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "drawStyle": "line", "lineWidth": 2, "fillOpacity": 15, "pointSize": 4 }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Critical" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "red" } }] },
          { "matcher": { "id": "byName", "options": "High" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "orange" } }] },
          { "matcher": { "id": "byName", "options": "Medium" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "yellow" } }] },
          { "matcher": { "id": "byName", "options": "Low" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "blue" } }] },
          { "matcher": { "id": "byName", "options": "Anomaly Signals" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "purple" } }] },
          { "matcher": { "id": "byName", "options": "Rule Matches" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "green" } }] }
        ]
      }
    },
    {
      "type": "piechart",
      "title": "Detections by Severity (24h)",
      "gridPos": { "h": 9, "w": 8, "x": 16, "y": 23 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT\n  multiIf(\n    risk_level = 'critical', 'Critical',\n    risk_level = 'high', 'High',\n    risk_level = 'medium', 'Medium',\n    risk_level = 'low', 'Low',\n    'Unknown'\n  ) AS Severity,\n  count() AS Count\nFROM soc.anomalies\nWHERE created_at >= now() - INTERVAL 24 HOUR\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY risk_level\nORDER BY\n  multiIf(risk_level='critical', 1, risk_level='high', 2, risk_level='medium', 3, risk_level='low', 4, 5)"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "fixed" },
          "custom": { "hideFrom": { "tooltip": false, "viz": false, "legend": false } }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Critical" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "dark-red" } }] },
          { "matcher": { "id": "byName", "options": "High" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "dark-orange" } }] },
          { "matcher": { "id": "byName", "options": "Medium" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "dark-yellow" } }] },
          { "matcher": { "id": "byName", "options": "Low" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "dark-blue" } }] }
        ]
      },
      "options": {
        "reduceOptions": { "values": false, "calcs": ["lastNotNull"] },
        "pieType": "pie",
        "tooltip": { "mode": "single" },
        "legend": {
          "displayMode": "table",
          "placement": "right",
          "showLegend": true,
          "values": ["value", "percent"]
        }
      }
    },

    {
      "type": "geomap",
      "title": "Failed Logins by Country (24h)",
      "gridPos": { "h": 9, "w": 8, "x": 0, "y": 32 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT\n  geo_country AS country,\n  count() AS failures,\n  multiIf(\n    geo_country = 'US', 37.0902, geo_country = 'RU', 61.5240, geo_country = 'CN', 35.8617,\n    geo_country = 'IN', 20.5937, geo_country = 'GB', 55.3781, geo_country = 'DE', 51.1657,\n    geo_country = 'FR', 46.2276, geo_country = 'JP', 36.2048, geo_country = 'AU', -25.2744,\n    geo_country = 'CA', 56.1304, geo_country = 'BR', -14.2350, geo_country = 'MX', 23.6345,\n    0.0\n  ) AS latitude,\n  multiIf(\n    geo_country = 'US', -95.7129, geo_country = 'RU', 105.3188, geo_country = 'CN', 104.1954,\n    geo_country = 'IN', 78.9629, geo_country = 'GB', -3.4360, geo_country = 'DE', 10.4515,\n    geo_country = 'FR', 2.2137, geo_country = 'JP', 138.2529, geo_country = 'AU', 133.7751,\n    geo_country = 'CA', -106.3468, geo_country = 'BR', -51.9253, geo_country = 'MX', -102.5528,\n    0.0\n  ) AS longitude\nFROM soc.enriched_logs\nWHERE timestamp >= now() - INTERVAL 24 HOUR\n  AND (method='app/login' OR positionCaseInsensitive(method,'login')>0 OR positionCaseInsensitive(message,'Wrong pin')>0)\n  AND (severity_num >= 40 OR status_code >= 400)\n  AND geo_country != 'UNKNOWN' AND geo_country != ''\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY geo_country, latitude, longitude\nORDER BY failures DESC"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": {
            "hideFrom": { "tooltip": false, "viz": false, "legend": false }
          }
        }
      },
      "options": {
        "view": { "id": "coords", "lat": 20, "lon": 0, "zoom": 2 },
        "controls": { "showZoom": true, "showAttribution": true },
        "basemap": { "type": "default" },
        "layers": [
          {
            "type": "markers",
            "config": { "size": { "fixed": 5, "min": 2, "max": 15, "field": "failures" }, "color": { "fixed": "red" }, "fillOpacity": 0.6 },
            "location": { "mode": "coords", "latitude": "latitude", "longitude": "longitude" },
            "tooltip": true
          }
        ]
      }
    },

    {
      "type": "timeseries",
      "title": "Failed Login Attempts (Fury Service - 'Wrong pin entered')",
      "gridPos": { "h": 9, "w": 8, "x": 8, "y": 32 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT\n  toStartOfFiveMinute(timestamp) AS time,\n  count() AS \"Failed Logins (Wrong Pin)\"\nFROM soc.enriched_logs\nWHERE $__timeFilter(timestamp)\n  AND service = 'fury'\n  AND namespace = 'apps'\n  AND severity = 'ERROR'\n  AND positionCaseInsensitive(message, 'Wrong pin entered') > 0\n  AND match(project,'$project') AND match(cluster,'$cluster')\nGROUP BY time\nORDER BY time"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "drawStyle": "line", "lineInterpolation": "smooth", "lineWidth": 2, "fillOpacity": 20, "pointSize": 5 }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Failed Logins (Wrong Pin)" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "red" } }] }
        ]
      }
    },

    {
      "type": "stat",
      "title": "Total Failed Logins (Wrong Pin) - 24h",
      "gridPos": { "h": 4, "w": 4, "x": 16, "y": 32 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT count() AS value\nFROM soc.enriched_logs\nWHERE timestamp >= now() - INTERVAL 24 HOUR\n  AND service = 'fury'\n  AND namespace = 'apps'\n  AND severity = 'ERROR'\n  AND positionCaseInsensitive(message, 'Wrong pin entered') > 0\n  AND match(project,'$project') AND match(cluster,'$cluster')"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 10 },
              { "color": "orange", "value": 50 },
              { "color": "red", "value": 100 }
            ]
          }
        }
      }
    },

    {
      "type": "stat",
      "title": "Unique IPs (Wrong Pin) - 24h",
      "gridPos": { "h": 5, "w": 4, "x": 20, "y": 32 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT uniq(ip) AS value\nFROM soc.enriched_logs\nWHERE timestamp >= now() - INTERVAL 24 HOUR\n  AND service = 'fury'\n  AND namespace = 'apps'\n  AND severity = 'ERROR'\n  AND positionCaseInsensitive(message, 'Wrong pin entered') > 0\n  AND ip != ''\n  AND match(project,'$project') AND match(cluster,'$cluster')"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 5 },
              { "color": "red", "value": 20 }
            ]
          }
        }
      }
    },

    {
      "type": "timeseries",
      "title": "Log Volume by Severity (5m)",
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 25 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT toStartOfFiveMinute(timestamp) AS time,\n       countIf(severity='INFO') AS \"INFO\",\n       countIf(severity='WARNING') AS \"WARNING\",\n       countIf(severity='ERROR') AS \"ERROR\",\n       countIf(severity='CRITICAL') AS \"CRITICAL\"\nFROM soc.enriched_logs\nWHERE $__timeFilter(timestamp)\n  AND method != 'k8s.inventory'\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY time\nORDER BY time"
        }
      ],
      "fieldConfig": { "defaults": { "custom": { "drawStyle": "bars", "lineWidth": 1, "fillOpacity": 70, "stacking": { "mode": "normal", "group": "sev" } } } }
    },

    {
      "type": "barchart",
      "title": "Top Services by Detections (24h)",
      "gridPos": { "h": 10, "w": 8, "x": 0, "y": 35 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT service, count() AS incidents\nFROM soc.anomalies\nWHERE created_at >= now() - INTERVAL 24 HOUR\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY service\nORDER BY incidents DESC\nLIMIT 15"
        }
      ],
      "options": { "orientation": "horizontal", "showValue": "always" }
    },
    {
      "type": "barchart",
      "title": "Top Namespaces by Activity (24h)",
      "gridPos": { "h": 10, "w": 8, "x": 8, "y": 35 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT namespace, count() AS logs\nFROM soc.raw_logs\nWHERE timestamp >= now() - INTERVAL 24 HOUR\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY namespace\nORDER BY logs DESC\nLIMIT 15"
        }
      ],
      "options": { "orientation": "horizontal", "showValue": "always" }
    },
    {
      "type": "barchart",
      "title": "Top Pods by Anomalies (24h)",
      "gridPos": { "h": 10, "w": 8, "x": 16, "y": 35 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT concat(service, '/', pod) AS pod_name, count() AS detections\nFROM soc.anomaly_signals\nWHERE created_at >= now() - INTERVAL 24 HOUR\n  AND pod != ''\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY pod_name\nORDER BY detections DESC\nLIMIT 15"
        }
      ],
      "options": { "orientation": "horizontal", "showValue": "always" }
    },

    {
      "type": "table",
      "title": "ðŸ”´ LIVE LOGS ANALYSIS - Real-Time Detections & Anomalies",
      "gridPos": { "h": 14, "w": 24, "x": 0, "y": 45 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT *\nFROM (\n  SELECT ts, kind, severity, project, cluster, namespace, service, pod, details\n  FROM (\n    SELECT created_at AS ts,\n           'anomaly' AS kind,\n           upper(risk_level) AS severity,\n           project, cluster, namespace, service, '' AS pod,\n           concat(model, ' score=', toString(round(score, 3)), ' ', substring(if(llm_summary != '', llm_summary, reason), 1, 180)) AS details\n    FROM soc.anomalies\n    WHERE $__timeFilter(created_at)\n      AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\n\n    UNION ALL\n\n    SELECT created_at AS ts,\n           'signal' AS kind,\n           upper(severity) AS severity,\n           project, cluster, namespace, service, pod,\n           concat(signal_type, ': ', substring(toJSONString(data), 1, 180)) AS details\n    FROM soc.anomaly_signals\n    WHERE $__timeFilter(created_at)\n      AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\n\n    UNION ALL\n\n    SELECT created_at AS ts,\n           'rule' AS kind,\n           upper(severity) AS severity,\n           project, cluster, namespace, service, '' AS pod,\n           concat(rule_id, ': ', description) AS details\n    FROM soc.rule_matches\n    WHERE $__timeFilter(created_at)\n      AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\n  )\n  ORDER BY ts DESC\n  LIMIT 300\n)\nORDER BY ts ASC"
        }
      ]
    },

    {
      "type": "timeseries",
      "title": "ðŸ”´ LIVE: Error Patterns & Anomaly Spikes (Real-Time)",
      "gridPos": { "h": 10, "w": 12, "x": 0, "y": 59 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT\n  toStartOfMinute(timestamp) AS time,\n  countIf(severity='ERROR' OR severity='CRITICAL') AS \"Errors\",\n  countIf(severity='WARNING') AS \"Warnings\"\nFROM soc.enriched_logs\nWHERE $__timeFilter(timestamp)\n  AND method != 'k8s.inventory'\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY time\nORDER BY time"
        },
        {
          "refId": "B",
          "queryType": "sql",
          "rawSql": "SELECT\n  toStartOfMinute(created_at) AS time,\n  count() AS \"Anomalies Detected\"\nFROM soc.anomalies\nWHERE $__timeFilter(created_at)\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY time\nORDER BY time"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "drawStyle": "line", "lineWidth": 2, "fillOpacity": 20 }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Errors" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "red" } }] },
          { "matcher": { "id": "byName", "options": "Warnings" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "orange" } }] },
          { "matcher": { "id": "byName", "options": "Anomalies Detected" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "purple" } }] }
        ]
      }
    },

    {
      "type": "table",
      "title": "ðŸ”´ LIVE: Recent Error Logs (Last Hour)",
      "gridPos": { "h": 10, "w": 12, "x": 12, "y": 59 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT\n  timestamp AS time,\n  service,\n  namespace,\n  severity,\n  ip,\n  identity,\n  substring(message, 1, 150) AS error_message\nFROM soc.enriched_logs\nWHERE timestamp >= now() - INTERVAL 1 HOUR\n  AND (severity = 'ERROR' OR severity = 'CRITICAL' OR severity = 'WARNING')\n  AND method != 'k8s.inventory'\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nORDER BY timestamp DESC\nLIMIT 100"
        }
      ],
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          { "matcher": { "id": "byName", "options": "severity" }, "properties": [{ "id": "custom.cellOptions", "value": { "type": "color-background" } }] }
        ]
      }
    },

    {
      "type": "stat",
      "title": "ðŸ”´ LIVE: Active Anomalies (Last Hour)",
      "gridPos": { "h": 5, "w": 6, "x": 0, "y": 69 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT count() AS value\nFROM soc.anomalies\nWHERE created_at >= now() - INTERVAL 1 HOUR\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 10 },
              { "color": "orange", "value": 50 },
              { "color": "red", "value": 100 }
            ]
          }
        }
      }
    },

    {
      "type": "stat",
      "title": "ðŸ”´ LIVE: Critical Signals (Last Hour)",
      "gridPos": { "h": 5, "w": 6, "x": 6, "y": 69 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT count() AS value\nFROM soc.anomaly_signals\nWHERE created_at >= now() - INTERVAL 1 HOUR\n  AND severity IN ('critical', 'high')\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 5 },
              { "color": "red", "value": 20 }
            ]
          }
        }
      }
    },

    {
      "type": "stat",
      "title": "ðŸ”´ LIVE: Services with Errors (Last Hour)",
      "gridPos": { "h": 5, "w": 6, "x": 12, "y": 69 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT uniq(service) AS value\nFROM soc.enriched_logs\nWHERE timestamp >= now() - INTERVAL 1 HOUR\n  AND (severity = 'ERROR' OR severity = 'CRITICAL')\n  AND method != 'k8s.inventory'\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 3 },
              { "color": "red", "value": 10 }
            ]
          }
        }
      }
    },

    {
      "type": "stat",
      "title": "ðŸ”´ LIVE: Error Rate (Last Hour)",
      "gridPos": { "h": 5, "w": 6, "x": 18, "y": 69 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT round(countIf(severity IN ('ERROR', 'CRITICAL')) * 100.0 / count(), 2) AS value\nFROM soc.enriched_logs\nWHERE timestamp >= now() - INTERVAL 1 HOUR\n  AND method != 'k8s.inventory'\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 },
              { "color": "orange", "value": 5 },
              { "color": "red", "value": 10 }
            ]
          }
        }
      }
    },

    {
      "type": "table",
      "title": "Service Health (last 1h)",
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 74 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT project, cluster, namespace, service,\n       sum(total_logs) AS total_logs,\n       round(avg(error_rate), 3) AS error_rate,\n       round(avg(pod_restart_rate), 2) AS restart_rate,\n       sum(container_escape_signals) AS escape_signals,\n       sum(failed_logins) AS failed_logins,\n       sum(iam_change_count) AS iam_changes\nFROM soc.features\nWHERE window_start >= now() - INTERVAL 60 MINUTE\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY project, cluster, namespace, service\nORDER BY error_rate DESC, restart_rate DESC, total_logs DESC\nLIMIT 300"
        }
      ]
    },

    {
      "type": "table",
      "title": "Operational Recommendations (auto-generated, last 24h)",
      "gridPos": { "h": 12, "w": 24, "x": 0, "y": 84 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT *\nFROM (\n  SELECT time, severity, project, cluster, namespace, service, recommendation\n  FROM (\n    SELECT window_start AS time,\n           'HIGH' AS severity,\n           project, cluster, namespace, service,\n           concat('âš ï¸ High error rate (', toString(round(error_rate, 3)), ') with volume=', toString(total_logs), '. Action: check recent deploy, upstream deps, autoscale, error budget.') AS recommendation\n    FROM soc.features\n    WHERE window_start >= now() - INTERVAL 24 HOUR\n      AND error_rate > 0.25 AND total_logs > 150\n      AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\n\n    UNION ALL\n\n    SELECT window_start AS time,\n           'MEDIUM' AS severity,\n           project, cluster, namespace, service,\n           concat('ðŸ”„ Restarts elevated (pod_restart_rate=', toString(round(pod_restart_rate, 2)), '). Action: inspect OOMKills, probes, node pressure, rollout history.') AS recommendation\n    FROM soc.features\n    WHERE window_start >= now() - INTERVAL 24 HOUR\n      AND pod_restart_rate > 1.0\n      AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\n\n    UNION ALL\n\n    SELECT created_at AS time,\n           upper(severity) AS severity,\n           project, cluster, namespace, service,\n           concat('ðŸš¨ Signal ', signal_type, ': ', substring(toJSONString(data), 1, 200), ' | Action: isolate blast radius, rate-limit, validate auth/WAF, check rollouts.') AS recommendation\n    FROM soc.anomaly_signals\n    WHERE created_at >= now() - INTERVAL 24 HOUR\n      AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\n\n    UNION ALL\n\n    SELECT created_at AS time,\n           upper(severity) AS severity,\n           project, cluster, namespace, service,\n           concat('âš¡ Rule ', rule_id, ': ', description, ' | Action: investigate ', identity, ' from ', JSONExtractString(toJSONString(evidence), 'ip'), ', review access logs, check for compromise.') AS recommendation\n    FROM soc.rule_matches\n    WHERE created_at >= now() - INTERVAL 24 HOUR\n      AND severity IN ('critical', 'high')\n      AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\n  )\n  ORDER BY time DESC\n  LIMIT 250\n)\nORDER BY time ASC"
        }
      ]
    }
  ]
}
