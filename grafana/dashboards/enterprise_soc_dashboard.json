{
  "uid": "enterprise-soc",
  "title": "SOC Ops (Production)",
  "timezone": "utc",
  "schemaVersion": 39,
  "version": 9,
  "refresh": "30s",
  "tags": ["soc-lab", "production"],
  "time": { "from": "now-6h", "to": "now" },
  "templating": {
    "list": [
      {
        "name": "DS_CLICKHOUSE",
        "type": "datasource",
        "label": "ClickHouse",
        "query": "grafana-clickhouse-datasource",
        "current": { "text": "ClickHouse", "value": "ClickHouse" }
      },
      {
        "name": "project",
        "type": "query",
        "label": "Project",
        "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
        "query": "SELECT distinct project FROM soc.raw_logs ORDER BY project",
        "refresh": 1,
        "multi": false,
        "includeAll": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      },
      {
        "name": "cluster",
        "type": "query",
        "label": "Cluster",
        "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
        "query": "SELECT distinct cluster FROM soc.raw_logs WHERE match(project, '$project') ORDER BY cluster",
        "refresh": 1,
        "multi": false,
        "includeAll": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      },
      {
        "name": "namespace",
        "type": "query",
        "label": "Namespace",
        "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
        "query": "SELECT distinct namespace FROM soc.raw_logs WHERE match(project, '$project') AND match(cluster, '$cluster') ORDER BY namespace",
        "refresh": 1,
        "multi": false,
        "includeAll": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      },
      {
        "name": "service",
        "type": "query",
        "label": "Service",
        "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
        "query": "SELECT distinct service FROM soc.raw_logs WHERE match(project, '$project') AND match(cluster, '$cluster') AND match(namespace, '$namespace') ORDER BY service",
        "refresh": 1,
        "multi": false,
        "includeAll": true,
        "allValue": ".*",
        "current": { "text": "All", "value": ".*" }
      }
    ]
  },
  "panels": [
    {
      "type": "table",
      "title": "ðŸš¨ TOP 10 SECURITY THREATS (Last 24h)",
      "gridPos": { "h": 9, "w": 24, "x": 0, "y": 0 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "WITH threat_data AS (\n  SELECT\n    rule_id,\n    rule_name,\n    severity,\n    description,\n    count() AS occurrences,\n    uniq(service) AS affected_services,\n    uniq(identity) AS unique_identities,\n    uniq(namespace) AS affected_namespaces,\n    max(created_at) AS last_seen,\n    multiIf(\n      severity='critical', 1,\n      severity='high', 2,\n      severity='medium', 3,\n      severity='low', 4,\n      5\n    ) AS severity_order\n  FROM soc.rule_matches\n  WHERE created_at >= now() - INTERVAL 24 HOUR\n    AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\n  GROUP BY rule_id, rule_name, severity, description\n)\nSELECT\n  rule_name AS \"Threat Name\",\n  severity AS \"Severity\",\n  occurrences AS \"Count (24h)\",\n  affected_services AS \"Services\",\n  affected_namespaces AS \"Namespaces\",\n  unique_identities AS \"Users/IDs\",\n  formatDateTime(last_seen, '%Y-%m-%d %H:%M') AS \"Last Seen\",\n  substring(description, 1, 80) AS \"Description\"\nFROM threat_data\nORDER BY severity_order ASC, occurrences DESC\nLIMIT 10"
        }
      ],
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          { "matcher": { "id": "byName", "options": "Severity" }, "properties": [
            { "id": "custom.cellOptions", "value": { "type": "color-background" } },
            { "id": "mappings", "value": [
              { "type": "value", "options": { "critical": { "color": "dark-red", "text": "CRITICAL" } } },
              { "type": "value", "options": { "high": { "color": "dark-orange", "text": "HIGH" } } },
              { "type": "value", "options": { "medium": { "color": "dark-yellow", "text": "MEDIUM" } } },
              { "type": "value", "options": { "low": { "color": "dark-blue", "text": "LOW" } } }
            ]}
          ]},
          { "matcher": { "id": "byName", "options": "Count (24h)" }, "properties": [
            { "id": "custom.cellOptions", "value": { "type": "color-background" } },
            { "id": "thresholds", "value": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 10 },
                { "color": "orange", "value": 50 },
                { "color": "red", "value": 100 }
              ]
            }}
          ]}
        ]
      },
      "options": { "showHeader": true, "sortBy": [] }
    },

    {
      "type": "stat",
      "title": "Total Logs (24h)",
      "gridPos": { "h": 3, "w": 4, "x": 0, "y": 9 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT count() AS value FROM soc.enriched_logs WHERE timestamp >= now() - INTERVAL 24 HOUR AND method != 'k8s.inventory' AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "color": { "mode": "thresholds" },
          "thresholds": { "mode": "absolute", "steps": [{ "color": "blue", "value": null }] }
        }
      },
      "options": { "graphMode": "area", "colorMode": "background" }
    },

    {
      "type": "stat",
      "title": "Total Anomalies (24h)",
      "gridPos": { "h": 3, "w": 4, "x": 4, "y": 9 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT count() AS value FROM soc.anomalies WHERE created_at >= now() - INTERVAL 24 HOUR AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "color": { "mode": "thresholds" },
          "thresholds": { "mode": "absolute", "steps": [{ "color": "purple", "value": null }, { "color": "red", "value": 100 }] }
        }
      },
      "options": { "graphMode": "area", "colorMode": "background" }
    },

    {
      "type": "stat",
      "title": "Total Signals (24h)",
      "gridPos": { "h": 3, "w": 4, "x": 8, "y": 9 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT count() AS value FROM soc.anomaly_signals WHERE window_start >= now() - INTERVAL 24 HOUR AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "color": { "mode": "thresholds" },
          "thresholds": { "mode": "absolute", "steps": [{ "color": "yellow", "value": null }] }
        }
      },
      "options": { "graphMode": "area", "colorMode": "background" }
    },

    {
      "type": "stat",
      "title": "Rule Matches (24h)",
      "gridPos": { "h": 3, "w": 4, "x": 12, "y": 9 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT count() AS value FROM soc.rule_matches WHERE created_at >= now() - INTERVAL 24 HOUR AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "color": { "mode": "thresholds" },
          "thresholds": { "mode": "absolute", "steps": [{ "color": "orange", "value": null }] }
        }
      },
      "options": { "graphMode": "area", "colorMode": "background" }
    },

    {
      "type": "stat",
      "title": "Critical Incidents (24h)",
      "gridPos": { "h": 3, "w": 4, "x": 16, "y": 9 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT countIf(risk_level='critical') AS value FROM soc.anomalies WHERE created_at >= now() - INTERVAL 24 HOUR AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "color": { "mode": "thresholds" },
          "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "red", "value": 1 }] }
        }
      },
      "options": { "graphMode": "area", "colorMode": "background" }
    },

    {
      "type": "stat",
      "title": "Ingest Lag (min)",
      "gridPos": { "h": 3, "w": 4, "x": 20, "y": 9 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT dateDiff('minute', max(timestamp), now()) AS value FROM soc.enriched_logs WHERE method != 'k8s.inventory'"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "m",
          "color": { "mode": "thresholds" },
          "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 10 }, { "color": "red", "value": 30 }] }
        }
      },
      "options": { "graphMode": "none", "colorMode": "background" }
    },

    {
      "type": "table",
      "title": "ðŸ’š Service Health (last 1h)",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 12 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT\n  service AS \"Service\",\n  namespace AS \"Namespace\",\n  count() AS \"Total Requests\",\n  countIf(severity IN ('ERROR', 'CRITICAL')) AS \"Errors\",\n  countIf(severity NOT IN ('ERROR', 'CRITICAL')) AS \"Success\",\n  round(countIf(severity NOT IN ('ERROR', 'CRITICAL')) * 100.0 / count(), 2) AS \"Success Rate %\",\n  round(countIf(severity IN ('ERROR', 'CRITICAL')) * 100.0 / count(), 2) AS \"Error Rate %\",\n  round(avg(status_code), 0) AS \"Avg Status\",\n  uniq(ip) AS \"Unique IPs\",\n  multiIf(\n    countIf(severity IN ('ERROR', 'CRITICAL')) * 100.0 / count() > 10, 'Critical',\n    countIf(severity IN ('ERROR', 'CRITICAL')) * 100.0 / count() > 5, 'Degraded',\n    countIf(severity IN ('ERROR', 'CRITICAL')) * 100.0 / count() > 1, 'Warning',\n    'Healthy'\n  ) AS \"Health Status\"\nFROM soc.enriched_logs\nWHERE timestamp >= now() - INTERVAL 1 HOUR\n  AND service != ''\n  AND method != 'k8s.inventory'\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY service, namespace\nORDER BY \"Error Rate %\" DESC, \"Total Requests\" DESC\nLIMIT 50"
        }
      ],
      "fieldConfig": {
        "defaults": {},
        "overrides": [
          { "matcher": { "id": "byName", "options": "Health Status" }, "properties": [
            { "id": "custom.cellOptions", "value": { "type": "color-background" } },
            { "id": "mappings", "value": [
              { "type": "value", "options": { "Healthy": { "color": "green", "text": "âœ… Healthy" } } },
              { "type": "value", "options": { "Warning": { "color": "yellow", "text": "âš ï¸ Warning" } } },
              { "type": "value", "options": { "Degraded": { "color": "orange", "text": "ðŸ”¶ Degraded" } } },
              { "type": "value", "options": { "Critical": { "color": "red", "text": "ðŸ”´ Critical" } } }
            ]}
          ]},
          { "matcher": { "id": "byName", "options": "Error Rate %" }, "properties": [
            { "id": "custom.cellOptions", "value": { "type": "color-background" } },
            { "id": "thresholds", "value": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 1 },
                { "color": "orange", "value": 5 },
                { "color": "red", "value": 10 }
              ]
            }},
            { "id": "unit", "value": "percent" }
          ]},
          { "matcher": { "id": "byName", "options": "Success Rate %" }, "properties": [
            { "id": "custom.cellOptions", "value": { "type": "color-background" } },
            { "id": "thresholds", "value": {
              "mode": "absolute",
              "steps": [
                { "color": "red", "value": null },
                { "color": "orange", "value": 90 },
                { "color": "yellow", "value": 95 },
                { "color": "green", "value": 99 }
              ]
            }},
            { "id": "unit", "value": "percent" }
          ]},
          { "matcher": { "id": "byName", "options": "Total Requests" }, "properties": [
            { "id": "custom.cellOptions", "value": { "type": "color-text" } },
            { "id": "thresholds", "value": {
              "mode": "absolute",
              "steps": [
                { "color": "text", "value": null },
                { "color": "blue", "value": 100 },
                { "color": "purple", "value": 1000 }
              ]
            }}
          ]}
        ]
      },
      "options": { "showHeader": true, "sortBy": [{ "displayName": "Error Rate %", "desc": true }] }
    },

    {
      "type": "timeseries",
      "title": "Detections Timeline (5m)",
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 20 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT\n  toStartOfFiveMinute(created_at) AS time,\n  countIf(risk_level='critical') AS \"Critical\",\n  countIf(risk_level='high') AS \"High\",\n  countIf(risk_level='medium') AS \"Medium\",\n  countIf(risk_level='low') AS \"Low\"\nFROM soc.anomalies\nWHERE $__timeFilter(created_at)\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY time\nORDER BY time"
        },
        {
          "refId": "B",
          "queryType": "sql",
          "rawSql": "SELECT\n  toStartOfFiveMinute(window_start) AS time,\n  count() AS \"Anomaly Signals\"\nFROM soc.anomaly_signals\nWHERE $__timeFilter(window_start)\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY time\nORDER BY time"
        },
        {
          "refId": "C",
          "queryType": "sql",
          "rawSql": "SELECT\n  toStartOfFiveMinute(created_at) AS time,\n  count() AS \"Rule Matches\"\nFROM soc.rule_matches\nWHERE $__timeFilter(created_at)\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY time\nORDER BY time"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "drawStyle": "line", "lineInterpolation": "smooth", "lineWidth": 2, "fillOpacity": 15 }
        },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Critical" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "dark-red" } }] },
          { "matcher": { "id": "byName", "options": "High" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "dark-orange" } }] },
          { "matcher": { "id": "byName", "options": "Medium" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "dark-yellow" } }] },
          { "matcher": { "id": "byName", "options": "Low" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "dark-blue" } }] },
          { "matcher": { "id": "byName", "options": "Anomaly Signals" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "purple" } }] },
          { "matcher": { "id": "byName", "options": "Rule Matches" }, "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "orange" } }] }
        ]
      }
    },

    {
      "type": "bargauge",
      "title": "ðŸ“Š Top 10 Services by Error Rate",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 28 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT\n  service,\n  round(countIf(severity IN ('ERROR', 'CRITICAL')) * 100.0 / count(), 2) AS error_rate\nFROM soc.enriched_logs\nWHERE timestamp >= now() - INTERVAL 6 HOUR\n  AND service != ''\n  AND method != 'k8s.inventory'\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY service\nHAVING count() >= 50\nORDER BY error_rate DESC\nLIMIT 10"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 },
              { "color": "orange", "value": 5 },
              { "color": "red", "value": 10 }
            ]
          }
        }
      },
      "options": {
        "orientation": "horizontal",
        "displayMode": "gradient",
        "showUnfilled": true
      }
    },

    {
      "type": "timeseries",
      "title": "â±ï¸ Service Response Times (P50, P95, P99)",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 28 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT\n  toStartOfFiveMinute(timestamp) AS time,\n  quantile(0.50)(status_code) AS \"P50\",\n  quantile(0.95)(status_code) AS \"P95\",\n  quantile(0.99)(status_code) AS \"P99\"\nFROM soc.enriched_logs\nWHERE $__timeFilter(timestamp)\n  AND status_code > 0\n  AND method != 'k8s.inventory'\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')\nGROUP BY time\nORDER BY time"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "custom": { "drawStyle": "line", "lineWidth": 2, "fillOpacity": 10 },
          "unit": "short"
        }
      }
    },

    {
      "type": "stat",
      "title": "ðŸ”´ LIVE: Active Anomalies (Last Hour)",
      "gridPos": { "h": 4, "w": 24, "x": 0, "y": 36 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "${DS_CLICKHOUSE}" },
      "targets": [
        {
          "refId": "A",
          "queryType": "sql",
          "rawSql": "SELECT count() AS value\nFROM soc.anomalies\nWHERE created_at >= now() - INTERVAL 1 HOUR\n  AND match(project,'$project') AND match(cluster,'$cluster') AND match(namespace,'$namespace') AND match(service,'$service')"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 10 },
              { "color": "orange", "value": 50 },
              { "color": "red", "value": 100 }
            ]
          }
        }
      },
      "options": { "graphMode": "area", "colorMode": "background" }
    }
  ]
}
