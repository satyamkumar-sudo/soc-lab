services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${AIRFLOW_DB_USER}
      POSTGRES_PASSWORD: ${AIRFLOW_DB_PASSWORD}
      POSTGRES_DB: ${AIRFLOW_DB_NAME}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${AIRFLOW_DB_USER} -d ${AIRFLOW_DB_NAME}"]
      interval: 5s
      timeout: 3s
      retries: 30
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks: [socnet]

  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./storage/initdb:/docker-entrypoint-initdb.d:ro
      - ./storage/clickhouse-config:/etc/clickhouse-server/config.d:ro
      - ./storage/clickhouse-users/001_profiles.xml:/etc/clickhouse-server/users.d/001_profiles.xml:ro
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --query 'SELECT 1' >/dev/null 2>&1"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks: [socnet]

  soc-api:
    build:
      context: .
      dockerfile: api/Dockerfile
    env_file: ${SOC_ENV_FILE:-.env}
    environment:
      PYTHONUNBUFFERED: "1"
      SOC_COMPONENT: soc-api
      KUBECONFIG: /kube/config
    volumes:
      - ./agents:/app/agents:ro
      - ./alerts:/app/alerts:ro
      - ./ingestion:/app/ingestion:ro
      - ./storage:/app/storage:ro
      - ./ml:/app/ml:rw
      - ./data:/app/data:rw
      - ./secrets:/secrets:ro
      - ./kubeconfig:/kube:ro
    depends_on:
      clickhouse:
        condition: service_healthy
    networks: [socnet]
    expose:
      - "8088"

  gateway:
    image: nginx:1.27-alpine
    depends_on:
      - soc-api
    ports:
      - "8443:8443"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/certs:ro
    networks: [socnet]

  airflow-init:
    build:
      context: .
      dockerfile: airflow/Dockerfile
    env_file: ${SOC_ENV_FILE:-.env}
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${AIRFLOW_DB_USER}:${AIRFLOW_DB_PASSWORD}@postgres:5432/${AIRFLOW_DB_NAME}
      AIRFLOW__CORE__FERNET_KEY: ${AIRFLOW__CORE__FERNET_KEY:-}
      _AIRFLOW_WWW_USER_USERNAME: ${AIRFLOW_ADMIN_USER}
      _AIRFLOW_WWW_USER_PASSWORD: ${AIRFLOW_ADMIN_PASSWORD}
      _AIRFLOW_WWW_USER_FIRSTNAME: SOC
      _AIRFLOW_WWW_USER_LASTNAME: Admin
      _AIRFLOW_WWW_USER_EMAIL: soc@example.com
      _AIRFLOW_WWW_USER_ROLE: Admin
      KUBECONFIG: /kube/config
    user: "${AIRFLOW_UID}:0"
    depends_on:
      postgres:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    volumes:
      - ./airflow/dags:/opt/airflow/dags:ro
      - ./airflow/plugins:/opt/airflow/plugins:ro
      - ./agents:/opt/soc/agents:ro
      - ./alerts:/opt/soc/alerts:ro
      - ./ingestion:/opt/soc/ingestion:ro
      - ./storage:/opt/soc/storage:ro
      - ./data:/opt/soc/data:rw
      - ./certs:/certs:ro
      - ./secrets:/secrets:ro
      - ./kubeconfig:/kube:ro
    entrypoint: /bin/bash
    command:
      - -c
      - |
        airflow db migrate &&
        airflow users create \
          --username "$${_AIRFLOW_WWW_USER_USERNAME}" \
          --password "$${_AIRFLOW_WWW_USER_PASSWORD}" \
          --firstname "$${_AIRFLOW_WWW_USER_FIRSTNAME}" \
          --lastname "$${_AIRFLOW_WWW_USER_LASTNAME}" \
          --role "$${_AIRFLOW_WWW_USER_ROLE}" \
          --email "$${_AIRFLOW_WWW_USER_EMAIL}" || true
    networks: [socnet]

  airflow-webserver:
    build:
      context: .
      dockerfile: airflow/Dockerfile
    env_file: ${SOC_ENV_FILE:-.env}
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${AIRFLOW_DB_USER}:${AIRFLOW_DB_PASSWORD}@postgres:5432/${AIRFLOW_DB_NAME}
      KUBECONFIG: /kube/config
    user: "${AIRFLOW_UID}:0"
    depends_on:
      airflow-init:
        condition: service_completed_successfully
    ports:
      - "8080:8080"
    volumes:
      - ./airflow/dags:/opt/airflow/dags:ro
      - ./airflow/plugins:/opt/airflow/plugins:ro
      - ./agents:/opt/soc/agents:ro
      - ./alerts:/opt/soc/alerts:ro
      - ./ingestion:/opt/soc/ingestion:ro
      - ./storage:/opt/soc/storage:ro
      - ./data:/opt/soc/data:rw
      - ./certs:/certs:ro
      - ./secrets:/secrets:ro
      - ./kubeconfig:/kube:ro
    command: webserver
    networks: [socnet]

  airflow-scheduler:
    build:
      context: .
      dockerfile: airflow/Dockerfile
    env_file: ${SOC_ENV_FILE:-.env}
    environment:
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://${AIRFLOW_DB_USER}:${AIRFLOW_DB_PASSWORD}@postgres:5432/${AIRFLOW_DB_NAME}
      KUBECONFIG: /kube/config
    user: "${AIRFLOW_UID}:0"
    depends_on:
      airflow-init:
        condition: service_completed_successfully
    volumes:
      - ./airflow/dags:/opt/airflow/dags:ro
      - ./airflow/plugins:/opt/airflow/plugins:ro
      - ./agents:/opt/soc/agents:ro
      - ./alerts:/opt/soc/alerts:ro
      - ./ingestion:/opt/soc/ingestion:ro
      - ./storage:/opt/soc/storage:ro
      - ./data:/opt/soc/data:rw
      - ./certs:/certs:ro
      - ./secrets:/secrets:ro
      - ./kubeconfig:/kube:ro
    command: scheduler
    networks: [socnet]

  grafana:
    image: grafana/grafana-oss:11.4.0
    depends_on:
      clickhouse:
        condition: service_healthy
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin_change_me
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_INSTALL_PLUGINS: grafana-clickhouse-datasource
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks: [socnet]

networks:
  socnet:
    driver: bridge

volumes:
  postgres_data:
  clickhouse_data:
  grafana_data:

